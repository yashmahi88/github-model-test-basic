name: Update Dynamic Knowledge Base

on:
  workflow_dispatch:

jobs:
  collect-logs:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and Combine GitHub Actions Logs
        run: |
          mkdir -p temp_logs

          echo "Combined GitHub Logs - $(date)" > temp_logs/dynamic_combined_logs.txt

          gh run list --workflow="train-precheck.yml" --limit 10 \
            --json databaseId,displayTitle,headBranch,conclusion,status,url,startedAt,updatedAt > temp_logs/run_history.json

          jq -r '.[] | select(.status == "completed") | .databaseId' temp_logs/run_history.json | while read -r RUN_ID; do
            echo -e "\n========== RUN $RUN_ID ==========\n" >> temp_logs/dynamic_combined_logs.txt
            gh run view "$RUN_ID" --log >> temp_logs/dynamic_combined_logs.txt
          done

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Upload Combined Log File to Azure Blob Storage
        run: |
          echo "Uploading to Azure Storage..."
          az storage blob upload \
            --account-name ${{ vars.AZURE_STORAGE_NAME }} \
            --container-name fileupload-test-data-index \
            --name dynamic_combined_logs.txt \
            --file temp_logs/dynamic_combined_logs.txt \
            --auth-mode key \
            --account-key ${{ secrets.AZURE_STORAGE_KEY }} \
            --overwrite

      - name: Clean Up Temporary Files
        run: rm -rf temp_logs
