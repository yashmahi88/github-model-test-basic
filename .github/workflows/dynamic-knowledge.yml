name: Update Dynamic Knowledge Base

on:
  # Uncomment for automatic scheduling
  # push:
  # schedule:
  #   - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  collect-logs:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and Combine GitHub Actions Logs
        run: |
          mkdir -p dynamic-knowledge

          echo "Combined GitHub Logs - $(date)" > dynamic-knowledge/dynamic_combined_logs.txt

          gh run list --workflow="train-precheck.yml" --limit 10 \
            --json databaseId,displayTitle,headBranch,conclusion,status,url,startedAt,updatedAt > dynamic-knowledge/run_history.json

          jq -r '.[] | select(.status == "completed") | .databaseId' dynamic-knowledge/run_history.json | while read -r RUN_ID; do
            echo "Fetching logs for run $RUN_ID..."
            echo -e "\n========== RUN $RUN_ID ==========\n" >> dynamic-knowledge/dynamic_combined_logs.txt
            gh run view "$RUN_ID" --log >> dynamic-knowledge/dynamic_combined_logs.txt
          done

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Upload Combined Log File to Azure Blob Storage
        run: |
          echo "Uploading dynamic_combined_logs.txt to Azure Blob Storage..."

          az storage blob upload \
            --account-name ${{ vars.AZURE_STORAGE_NAME }} \
            --container-name fileupload-test-data-index \
            --name dynamic_combined_logs.txt \
            --file dynamic-knowledge/dynamic_combined_logs.txt \
            --auth-mode key \
            --account-key ${{ secrets.AZURE_STORAGE_KEY }} \
            --overwrite
