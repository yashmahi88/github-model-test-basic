name: Update Dynamic Knowledge Base

on:
  # Uncomment below for automatic schedule (e.g., every hour)
  # push:
  # schedule:
  #   - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  collect-logs:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch GitHub Actions Logs & History
        run: |
          mkdir -p dynamic-knowledge/logs

          # Fetch run history for a specific workflow
          gh run list --workflow="train-precheck.yml" --limit 10 \
            --json databaseId,displayTitle,headBranch,conclusion,status,url,startedAt,updatedAt > dynamic-knowledge/run_history.json

          # Extract completed run IDs
          jq -r '.[] | select(.status == "completed") | .databaseId' dynamic-knowledge/run_history.json | while read -r RUN_ID; do
            echo "Fetching logs for run $RUN_ID..."
            gh run view "$RUN_ID" --log > "dynamic-knowledge/logs/log_${RUN_ID}.txt"
          done

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Upload Logs to Azure Blob Storage
        run: |
          echo "Uploading logs to Azure Storage..."

          az storage blob upload-batch \
            --account-name ${{ vars.AZURE_STORAGE_NAME }} \
            --destination fileupload-test-data-index \
            --source dynamic-knowledge/logs \
            --auth-mode key \
            --account-key ${{ secrets.AZURE_STORAGE_KEY }} \
            --overwrite
